<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Audio Streaming</title>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <button id="startRecording">Start Recording</button>
    <button id="stopRecording">Stop Recording</button>

    <script>
      $(document).ready(() => {
        const socket = io();
        let mediaRecorder, microphoneStream;
        const audioContext = new (window.AudioContext ||
          window.webkitAudioContext)();

        $("#startRecording").on("click", () => {
          $(document).one("click", () => {
            socket.emit("prepare");

            navigator.mediaDevices
              .getUserMedia({ audio: true })
              .then((stream) => {
                microphoneStream = stream;
                mediaRecorder = new MediaRecorder(stream);
                console.log({ mediaRecorder });

                mediaRecorder.ondataavailable = function (event) {
                  if (event.data.size > 0) {
                    console.count("client");
                    const audioBlob = new Blob([event.data], {
                      type: "audio/webm;codecs=opus",
                    });
                    socket.emit("audio", audioBlob);
                  }
                };

                mediaRecorder.start(100);
              })
              .catch((err) => {
                console.error("Error accessing microphone:", err);
              });
          });
        });

        $("#stopRecording").on("click", () => {
          $(document).one("click", () => {
            if (microphoneStream) {
              microphoneStream.getTracks().forEach((track) => track.stop());
              microphoneStream = null;
            }

            if (mediaRecorder) {
              mediaRecorder.stop();
              mediaRecorder = null;
            }

            socket.emit("stop");
          });
        });
      });
    </script>
  </body>
</html>
